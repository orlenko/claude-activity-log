{% extends "base.html" %}

{% block title %}Session {{ session.session_id[:12] }} - Claude Activity Logger{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <nav class="text-sm mb-2">
                <a href="{{ url_for('sessions') }}" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">Sessions</a>
                <span class="text-gray-400 mx-2">/</span>
                <span class="text-gray-900 dark:text-white">{{ session.session_id[:12] }}</span>
            </nav>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Session Details</h1>
        </div>
    </div>

    <!-- Session Info Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div>
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Session ID</div>
                <div class="mt-1 text-sm font-mono text-gray-900 dark:text-white">{{ session.session_id[:16] }}...</div>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Project</div>
                <div class="mt-1">
                    {% if session.project %}
                    <a href="{{ url_for('project_detail', project_id=session.project.id) }}"
                       class="text-sm text-claude-orange hover:underline">
                        {{ session.project.name or session.project.path }}
                    </a>
                    {% else %}
                    <span class="text-sm text-gray-900 dark:text-white">Unknown</span>
                    {% endif %}
                </div>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Started</div>
                <div class="mt-1 text-sm text-gray-900 dark:text-white">{{ session.started_at|localtime }}</div>
            </div>
            <div>
                <div class="text-sm font-medium text-gray-500 dark:text-gray-400">Git Branch</div>
                <div class="mt-1 text-sm text-gray-900 dark:text-white">{{ session.git_branch or 'N/A' }}</div>
            </div>
        </div>
    </div>

    <!-- Generate Context Button -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Resume This Work</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                    Generate a context summary to continue this work in a new Claude session
                </p>
            </div>
            <button hx-post="{{ url_for('generate_session_context', session_id=session.session_id) }}"
                    hx-target="#context-container"
                    hx-indicator="#context-loading"
                    class="inline-flex items-center px-4 py-2 bg-claude-orange text-white rounded-md text-sm font-medium hover:bg-opacity-90">
                <span id="context-loading" class="htmx-indicator mr-2">
                    <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                Generate Context Summary
            </button>
        </div>
        <div id="context-container">
            <!-- Context will be loaded here via HTMX -->
        </div>
    </div>

    <!-- Conversation -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
                Conversation
                <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
                    ({{ session.messages|length }} messages)
                </span>
            </h2>
            <div class="flex space-x-2">
                <button onclick="expandAll()" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    Expand all
                </button>
                <span class="text-gray-300 dark:text-gray-600">|</span>
                <button onclick="collapseAll()" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    Collapse all
                </button>
            </div>
        </div>

        <div class="divide-y divide-gray-200 dark:divide-gray-700">
            {% for msg in session.messages %}
            <div class="p-6 {% if msg.role == 'user' %}message-user bg-blue-50/50 dark:bg-blue-900/10{% else %}message-assistant bg-green-50/50 dark:bg-green-900/10{% endif %}">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <!-- Avatar -->
                        {% if msg.role == 'user' %}
                        <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                            <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                        {% else %}
                        <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center">
                            <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8 12a2 2 0 114 0 2 2 0 01-4 0zm2-6a1 1 0 011 1v3a1 1 0 11-2 0V7a1 1 0 011-1z"/>
                            </svg>
                        </div>
                        {% endif %}
                        <span class="text-sm font-semibold {% if msg.role == 'user' %}text-blue-700 dark:text-blue-300{% else %}text-green-700 dark:text-green-300{% endif %}">
                            {{ msg.role|capitalize }}
                        </span>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">
                        {{ msg.timestamp|localtime }}
                    </span>
                </div>

                {% set content = msg.content or '' %}
                <div id="msg-{{ loop.index }}"
                     class="message-content prose prose-sm dark:prose-invert max-w-none text-gray-700 dark:text-gray-300 whitespace-pre-wrap {% if content|length <= 1000 %}expanded{% endif %}">{{ content }}</div>

                {% if content|length > 1000 %}
                <button id="btn-{{ loop.index }}" onclick="toggleMessage({{ loop.index }})"
                        class="mt-3 inline-flex items-center text-sm text-claude-orange hover:underline">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                    Show more
                </button>
                {% endif %}
            </div>
            {% else %}
            <div class="p-6 text-center text-gray-500 dark:text-gray-400">
                No messages in this session
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    function expandAll() {
        document.querySelectorAll('.message-content').forEach(el => {
            el.classList.add('expanded');
        });
        document.querySelectorAll('[id^="btn-"]').forEach(el => {
            el.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>Show less';
        });
    }

    function collapseAll() {
        document.querySelectorAll('.message-content').forEach(el => {
            // Only collapse if content is long
            if (el.scrollHeight > 200) {
                el.classList.remove('expanded');
            }
        });
        document.querySelectorAll('[id^="btn-"]').forEach(el => {
            el.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>Show more';
        });
    }

    function toggleMessage(id) {
        const content = document.getElementById('msg-' + id);
        const button = document.getElementById('btn-' + id);
        if (content.classList.contains('expanded')) {
            content.classList.remove('expanded');
            button.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>Show more';
        } else {
            content.classList.add('expanded');
            button.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg>Show less';
        }
    }
</script>
{% endblock %}
