{% extends "base.html" %}

{% block title %}Live Activity - Agent Activity Logger{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white flex items-center">
                <span class="w-3 h-3 bg-green-500 rounded-full mr-3 animate-pulse"></span>
                Live Activity Feed
            </h1>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
                Real-time view of all Claude activity across projects
            </p>
        </div>

        <!-- Project Filter -->
        <div class="flex items-center space-x-4">
            <form method="get" class="flex items-center space-x-2">
                <label for="project_id" class="text-sm text-gray-600 dark:text-gray-400">Filter:</label>
                <select name="project_id" id="project_id" onchange="this.form.submit()"
                        class="text-sm border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-1.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">All Projects</option>
                    {% for p in projects %}
                    <option value="{{ p.id }}" {% if p.id == selected_project_id %}selected{% endif %}>
                        {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </form>

            <!-- Auto-scroll toggle -->
            <label class="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-400 cursor-pointer">
                <input type="checkbox" id="auto-scroll" checked
                       class="rounded border-gray-300 dark:border-gray-600 text-green-500 focus:ring-green-500">
                <span>Auto-scroll</span>
            </label>

            <!-- Pause/Resume -->
            <button id="pause-btn" onclick="togglePause()"
                    class="px-3 py-1.5 text-sm bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                Pause
            </button>
        </div>
    </div>

    <!-- Live Feed Container -->
    <div class="bg-gray-900 rounded-lg shadow-lg overflow-hidden font-mono text-sm">
        <!-- Terminal Header -->
        <div class="bg-gray-800 px-4 py-2 flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center space-x-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
            </div>
            <div class="text-gray-400 text-xs">
                <span id="entry-count">{{ entries|length }}</span> entries
                <span class="mx-2">|</span>
                <span id="status-indicator" class="text-green-400">Streaming</span>
            </div>
        </div>

        <!-- Terminal Content -->
        <div id="live-feed" class="h-[600px] overflow-y-auto p-4 space-y-1"
             hx-get="{{ url_for('api_live_entries', project_id=selected_project_id) }}"
             hx-trigger="every 2s"
             hx-swap="afterbegin"
             hx-target="#live-entries">
            <div id="live-entries">
                {% include "partials/live_entries.html" %}
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="flex items-center justify-center space-x-6 text-sm text-gray-500 dark:text-gray-400">
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 bg-blue-500 rounded"></span>
            <span>User</span>
        </div>
        <div class="flex items-center space-x-2">
            <span class="w-3 h-3 bg-green-500 rounded"></span>
            <span>Assistant</span>
        </div>
    </div>
</div>

<script>
    let isPaused = false;
    let lastSeenId = null;
    const liveFeed = document.getElementById('live-feed');
    const liveEntries = document.getElementById('live-entries');

    // Track the latest entry ID for incremental updates
    function updateLastSeenId() {
        const firstEntry = liveEntries.querySelector('[data-entry-id]');
        if (firstEntry) {
            lastSeenId = parseInt(firstEntry.dataset.entryId, 10);
        }
    }

    // Add since_id to HTMX requests to avoid duplicates
    liveFeed.addEventListener('htmx:configRequest', function(evt) {
        if (lastSeenId !== null) {
            evt.detail.parameters['since_id'] = lastSeenId;
        }
    });

    // Handle new entries arriving
    liveFeed.addEventListener('htmx:afterSwap', function(evt) {
        // Deduplicate entries (in case of race conditions)
        const seenIds = new Set();
        liveEntries.querySelectorAll('.live-entry').forEach(function(entry) {
            const id = entry.dataset.entryId;
            if (seenIds.has(id)) {
                entry.remove();
            } else {
                seenIds.add(id);
            }
        });

        updateLastSeenId();
        updateEntryCount();

        // Auto-scroll if enabled
        if (document.getElementById('auto-scroll').checked && !isPaused) {
            liveFeed.scrollTop = 0;  // Scroll to top since newest are first
        }

        // Limit total entries to prevent memory issues
        const entries = liveEntries.querySelectorAll('.live-entry');
        if (entries.length > 1000) {
            for (let i = 1000; i < entries.length; i++) {
                entries[i].remove();
            }
        }
    });

    function updateEntryCount() {
        const count = liveEntries.querySelectorAll('.live-entry').length;
        document.getElementById('entry-count').textContent = count;
    }

    function togglePause() {
        isPaused = !isPaused;
        const btn = document.getElementById('pause-btn');
        const indicator = document.getElementById('status-indicator');

        if (isPaused) {
            btn.textContent = 'Resume';
            btn.classList.add('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
            btn.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            indicator.textContent = 'Paused';
            indicator.classList.remove('text-green-400');
            indicator.classList.add('text-yellow-400');
            liveFeed.removeAttribute('hx-trigger');
            htmx.process(liveFeed);
        } else {
            btn.textContent = 'Pause';
            btn.classList.remove('bg-green-100', 'dark:bg-green-900', 'text-green-700', 'dark:text-green-300');
            btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            indicator.textContent = 'Streaming';
            indicator.classList.add('text-green-400');
            indicator.classList.remove('text-yellow-400');
            liveFeed.setAttribute('hx-trigger', 'every 2s');
            htmx.process(liveFeed);
        }
    }

    // Handle pause state for HTMX requests
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (isPaused && evt.target.id === 'live-feed') {
            evt.preventDefault();
        }
    });

    // Initialize
    updateLastSeenId();
</script>
{% endblock %}
